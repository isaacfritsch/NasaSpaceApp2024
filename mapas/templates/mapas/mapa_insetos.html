<script>
    // Inicializa o mapa com o token de acesso do Mapbox
    mapboxgl.accessToken = 'pk.eyJ1IjoiaXNhYWNmcml0c2NoMiIsImEiOiJjbTF3bjh5MXUwcHBhMmpvbnQxYzFyOGJhIn0.ZHG6sujbL8tqshwhteDVLQ';
    
// Configurações para paginação
// Configurações para paginação
// Configurações para paginação
let currentPage = 1; // Página inicial
const perPage = 200; // Máximo de resultados por página (ajustado para 200)
let totalFetched = 0; // Contagem de resultados obtidos
const maxResults = 2000; // Limitar a 2000 resultados
let totalPages = 1; // Inicialmente definida, será atualizada após a primeira chamada da API

function fetchPlantData(page) {
    // Chamada à API do iNaturalist com bounding box para o Brasil e paginação
    fetch(`https://api.inaturalist.org/v1/observations?taxon_id=47158&has=photos&nelat=1.73374&nelng=-35.75157&swlat=-21.76120&swlng=-57.28477&per_page=${perPage}&page=${page}`)
        .then(response => response.json())
        .then(data => {
            

            // Atualiza o total de páginas com base no número total de resultados
            if (page === 1) {
                totalPages = Math.ceil(data.total_results / perPage);
                
            }

            data.results.forEach(observation => {
                if (totalFetched >= maxResults) return; // Para se atingirmos o máximo de 2000 resultados

                // Verifica se há coordenadas geográficas
                if (observation.geojson && observation.geojson.coordinates && observation.photos.length > 0) {
                    const lng = observation.geojson.coordinates[0];
                    const lat = observation.geojson.coordinates[1];

                    
                    const photoUrl = observation.photos[0].url; // URL da foto
                    const species = observation.species_guess || 'Espécie desconhecida'; // Nome da espécie (ou desconhecida)

                    // Adiciona um marcador no mapa
                    const marker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Cria o conteúdo do popup com as informações da planta e imagem
                    const popupContent = `
                        <h3>${species}</h3>
                        <p>Observado em: ${new Date(observation.time_observed_at).toLocaleDateString()}</p>
                        <img src="${photoUrl}" alt="Imagem da planta" style="width:100%;"/>
                    `;

                    // Adiciona um popup ao marcador
                    const popup = new mapboxgl.Popup({ offset: 25 })
                        .setHTML(popupContent);

                    marker.setPopup(popup);

                    totalFetched++; // Incrementa o número de resultados processados
                } 
            });

            // Verifica se há mais páginas e se ainda não atingimos o limite de 2000 resultados
            if (page < totalPages && totalFetched < maxResults) {
                currentPage++;
                fetchPlantData(currentPage); // Buscar a próxima página
            }
        })
        .catch(error => {
            console.error('Erro ao buscar dados da API do iNaturalist:', error);
        });
}

// Inicializa o mapa com o token de acesso do Mapbox
mapboxgl.accessToken = 'pk.eyJ1IjoiaXNhYWNmcml0c2NoMiIsImEiOiJjbTF3bjh5MXUwcHBhMmpvbnQxYzFyOGJhIn0.ZHG6sujbL8tqshwhteDVLQ';

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-46, -14], // Centro ajustado para o Brasil
    zoom: 5 // Zoom ajustado para mostrar o Brasil
});

// Chamada inicial para buscar dados da primeira página
fetchPlantData(currentPage);



</script>